<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡∏Ñ‡∏•‡∏±‡∏á‡∏®‡∏≤‡∏•‡∏≤‡∏¢‡∏≤</title>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
body{
    font-family:"Prompt", sans-serif; background:#f4f7fb; margin:0;
}

/* ---------------------------------------------------
   STICKY HEADER + FILTER + SUMMARY + TABLE HEADER
----------------------------------------------------*/

/* HEADER */
header{
    background:white; padding:20px 40px; display:flex; align-items:center;
    border-bottom:1px solid #ddd;
    position:sticky;
    top:0;
    z-index:3000;
}

/* FILTER BAR */
.filter-box{
    background:white; padding:20px; display:flex; gap:15px; flex-wrap:wrap;
    position:sticky;
    top:var(--topFilter);
    z-index:2500;
    border-bottom:1px solid #ddd;
}

/* SUMMARY BAR */
.summary-container{
    background:#f4f7fb;
    padding:20px;
    display:flex;
    gap:20px;
    position:sticky;
    top:var(--topSummary);
    z-index:2200;
}

/* TABLE HEADER */
thead th{
    position:sticky;
    top:var(--topTableHead);
    background:#1E3A8A;
    color:white;
    z-index:2000;
}

/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
table{
    width:100%; border-collapse:collapse; background:white; margin-top:20px;
}
th,td{
    padding:10px;
    border-bottom:1px solid #eee;
    text-align:center;
}

/* Summary Card */
.summary-card{
    flex:1; padding:20px; border-radius:12px; font-size:20px;
    font-weight:bold; color:white; text-align:center;
}
.pass{ background:#10B981; }
.fail{ background:#EF4444; }
.total{ background:#475569; }

select,input{
    padding:10px 14px; border:1px solid #bbb; border-radius:8px; font-size:16px;
}
button{
    padding:10px 18px; border:none; color:white; border-radius:8px; cursor:pointer;
}
.load-btn{ background:#2563EB; }
.view-btn{ background:#1E40AF; }
.export-btn{ background:#047857; }

.details-row{ background:#eef3ff; }
.details-box{ padding:15px 30px; text-align:left; }

/* Lightbox */
#lightbox{
    display:none; position:fixed; inset:0; 
    background:rgba(0,0,0,0.85);
    justify-content:center; align-items:center;
    z-index:9999;
}
#lightbox img{
    max-width:90%; max-height:90%; border-radius:12px;
}

.thumb{ width:120px; border-radius:8px; cursor:pointer; }
.toggle-btn{ cursor:pointer; color:#1E40AF; font-weight:600; }
.toggle-btn:hover{ text-decoration:underline; }

.zip-btn{
    background:#7C3AED; padding:8px 14px; border-radius:6px;
}
</style>
</head>

<body>

<header>
    <img src="logo.png" style="height:60px; margin-right:15px;">
    <h1>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡∏Ñ‡∏•‡∏±‡∏á‡∏®‡∏≤‡∏•‡∏≤‡∏¢‡∏≤</h1>
</header>

<div class="filter-box">
    <select id="carType">
        <option value="car">üöó ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</option>
        <option value="motor">üèçÔ∏è ‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå</option>
    </select>

    <select id="yearSelect"></select>
    <select id="monthSelect">
        <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
        <script>
            for(let m=1;m<=12;m++){
                document.write(`<option value="${m}">${m}</option>`);
            }
        </script>
    </select>

    <input id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶">

    <button class="load-btn" onclick="loadData()">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="view-btn" onclick="loadData(true)">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button class="export-btn" onclick="exportPDF()">üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF</button>
</div>

<div class="summary-container">
    <div class="summary-card pass">‡∏ú‡πà‡∏≤‡∏ô: <span id="passCount">0</span></div>
    <div class="summary-card fail">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: <span id="failCount">0</span></div>
    <div class="summary-card total">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalCount">0</span></div>
</div>

<div style="padding:20px;">
<table>
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
</table>
</div>

<!-- Lightbox -->
<div id="lightbox" onclick="this.style.display='none'">
    <img id="lightboxImg">
</div>


<script>
/* ---------------------------------------------------
   ‚≠ê Dynamic Sticky Position ‚Äî ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏±‡∏ö‡∏Å‡∏±‡∏ô 100%
----------------------------------------------------*/
function updateStickyPositions() {
    const header = document.querySelector("header");
    const filter = document.querySelector(".filter-box");
    const summary = document.querySelector(".summary-container");

    let h1 = header.offsetHeight;
    let h2 = filter.offsetHeight;
    let h3 = summary.offsetHeight;

    document.documentElement.style.setProperty("--topFilter", h1 + "px");
    document.documentElement.style.setProperty("--topSummary", (h1 + h2) + "px");
    document.documentElement.style.setProperty("--topTableHead", (h1 + h2 + h3) + "px");
}

window.addEventListener("load", updateStickyPositions);
window.addEventListener("resize", updateStickyPositions);


/* -----------------------
   Google Sheet Settings
-------------------------*/
const SHEETS = {
    car: "17RaQXYiBqKRuThFsIe78NQsZQAp3zgSLrq-JgFXDXpE",
    motor:"1fpLMthzvhCRKenfnsQfpomEJLxgAOYZuYvrBCGzzseI"
};
const TABS = { car:"car", motor:"motor" };


/* ------------------------------
   ‚≠ê ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏°‡∏≠‡∏á‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
   ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏µ space / ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ú‡∏¥‡∏î
------------------------------*/
function findColumn(row, keyword){
    return Object.keys(row).find(key => key.trim().includes(keyword));
}


/* Groups */
const CAR_GROUPS = {
    "‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å": ["‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏á","‡∏™‡∏†‡∏≤‡∏û‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å","‡∏Å‡∏£‡∏∞‡∏à‡∏Å","‡∏õ‡∏±‡∏î‡∏ô‡πâ‡∏≥‡∏ù‡∏ô","‡πÑ‡∏ü‡∏´‡∏ô‡πâ‡∏≤","‡πÑ‡∏ü‡∏ó‡πâ‡∏≤‡∏¢","‡πÑ‡∏ü‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß","‡∏¢‡∏≤‡∏á","‡∏Å‡∏±‡∏ô‡∏ä‡∏ô","‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡∏°‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏á"],
    "‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô": ["‡πÄ‡∏ö‡∏≤‡∏∞","‡πÄ‡∏Ç‡πá‡∏°‡∏Ç‡∏±‡∏î","‡πÅ‡∏ï‡∏£","‡πÑ‡∏ü‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì","‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏±‡∏î","‡πÅ‡∏≠‡∏£‡πå","‡∏û‡∏±‡∏î‡∏•‡∏°","‡∏û‡∏£‡∏°","‡∏û‡∏∑‡πâ‡∏ô"],
    "‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå": ["‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á","‡∏ô‡πâ‡∏≥‡∏´‡∏•‡πà‡∏≠‡πÄ‡∏¢‡πá‡∏ô","‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà","‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏£‡∏Å","‡∏û‡∏ß‡∏á‡∏°‡∏≤‡∏•‡∏±‡∏¢"],
    "‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡∏ì‡∏∞‡∏Ç‡∏±‡∏ö": ["‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á","‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡πà‡∏á","‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡πå","‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏£‡∏Å","‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô","‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß"]
};

const MOTOR_GROUPS = {
    "‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å": ["‡∏ï‡∏±‡∏ß‡∏ñ‡∏±‡∏á","‡πÑ‡∏ü‡∏´‡∏ô‡πâ‡∏≤","‡πÑ‡∏ü‡∏ó‡πâ‡∏≤‡∏¢","‡πÑ‡∏ü‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏ß","‡∏¢‡∏≤‡∏á"],
    "‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô": ["‡πÅ‡∏ï‡∏£","‡πÑ‡∏ü‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì","‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏±‡∏î"],
    "‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå": ["‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á","‡∏ô‡πâ‡∏≥‡∏´‡∏•‡πà‡∏≠‡πÄ‡∏¢‡πá‡∏ô","‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà","‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏£‡∏Å"],
    "‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡∏ì‡∏∞‡∏Ç‡∏±‡∏ö": ["‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á","‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡πà‡∏á","‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡πå","‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏£‡∏Å","‡∏™‡∏±‡πà‡∏ô‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô"]
};


/* Google Drive URL */
function convertDriveURL(url){
    if (!url) return "";
    const match = url.match(/[-\w]{25,}/);
    if (!match) return "";
    return `https://drive.usercontent.google.com/download?id=${match[0]}&export=view`;
}

/* Lightbox */
function showImage(url){
    lightboxImg.src = url;
    lightbox.style.display = "flex";
}

/* Years */
let yearNow = new Date().getFullYear();
for (let y = yearNow; y >= yearNow-5; y--){
    yearSelect.innerHTML += `<option>${y}</option>`;
}

let GLOBAL_ROWS = [];


/* Load data */
function loadData(showAll=false){
    let type = carType.value;

    fetch(`https://opensheet.elk.sh/${SHEETS[type]}/${TABS[type]}`)
    .then(r=>r.json())
    .then(data=>{
        GLOBAL_ROWS = data;
        renderTable(showAll);
    });
}


/* Pass/Fail */
function checkCategory(row, keys){
    for (let col in row){
        if (keys.some(k=>col.includes(k))){
            let val = (row[col] || "").trim();
            if (val.includes("‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô") || val.includes("‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏°"))
                return "‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô";
        }
    }
    return "‚úî ‡∏ú‡πà‡∏≤‡∏ô";
}



function buildDetailList(row, keys){
    let html = "<ul>";
    for (let col in row){
        if (keys.some(k => col.includes(k))){
            html += `<li>${col}: ${row[col] || "-"}</li>`;
        }
    }
    html += "</ul>";
    return html;
}


/* Render table */
function renderTable(showAll){
    let type = carType.value;
    let GROUPS = type==="car" ? CAR_GROUPS : MOTOR_GROUPS;

    let year = yearSelect.value;
    let month = monthSelect.value;
    let search = searchInput.value.trim();

    let rows = GLOBAL_ROWS.filter(r=>{
        if (!r["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"]) return false;

        let d = new Date(r["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"]);
        let ok = true;

        if (!showAll && year) ok &= d.getFullYear()==year;
        if (!showAll && month) ok &= (d.getMonth()+1)==month;
        if (search) ok &= JSON.stringify(r).includes(search);

        return ok;
    });

    tableHead.innerHTML = `
        <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</th>
            <th>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</th>
            <th>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</th>
            <th>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏ñ</th>
            <th>‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å</th>
            <th>‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô</th>
            <th>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå</th>
            <th>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡∏ì‡∏∞‡∏Ç‡∏±‡∏ö</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
        </tr>
    `;

    let html = "";

    rows.forEach((row,i)=>{

        /* ‚≠ê ‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏ñ‡πÅ‡∏ö‡∏ö Dynamic */
        let colUser = findColumn(row, "‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏ñ");

        html += `
        <tr>
            <td>${row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"]||""}</td>
            <td>${row["‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå"]||""}</td>
            <td>${row["‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ"]||""}</td>
            <td>${row[colUser] || "-"}</td>
            <td class="toggle-btn" onclick="toggleDetails(${i},'ext')">‚ñ∂ ${checkCategory(row, GROUPS["‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å"])}</td>
            <td class="toggle-btn" onclick="toggleDetails(${i},'int')">‚ñ∂ ${checkCategory(row, GROUPS["‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô"])}</td>
            <td class="toggle-btn" onclick="toggleDetails(${i},'eng')">‚ñ∂ ${checkCategory(row, GROUPS["‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå"])}</td>
            <td class="toggle-btn" onclick="toggleDetails(${i},'dr')">‚ñ∂ ${checkCategory(row, GROUPS["‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡∏ì‡∏∞‡∏Ç‡∏±‡∏ö"])}</td>
            <td>${row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°"]||""}</td>
            <td class="toggle-btn" onclick="toggleDetails(${i},'img')">‚ñ∂ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
        </tr>
        `;

        ["ext","int","eng","dr"].forEach(cat=>{
            const title = {
                ext:"‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å", int:"‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô",
                eng:"‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå", dr:"‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ç‡∏ì‡∏∞‡∏Ç‡∏±‡∏ö"
            }[cat];

            html += `
            <tr id="details-${i}-${cat}" class="details-row" style="display:none;">
                <td colspan="10">
                    <div class="details-box">
                        <h4>${title}</h4>
                        ${buildDetailList(row, GROUPS[title])}
                    </div>
                </td>
            </tr>`;
        });

        html += `
        <tr id="details-${i}-img" class="details-row" style="display:none;">
            <td colspan="10">
                <div class="details-box">
                    <h4>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                    <div id="img-box-${i}" style="display:flex; gap:15px; flex-wrap:wrap;"></div>
                    <button class="zip-btn" onclick="downloadImages(${i})">‚¨á ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
            </td>
        </tr>`;
    });

    tableBody.innerHTML = html;

    let fail = rows.filter(r => JSON.stringify(r).includes("‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô") || JSON.stringify(r).includes("‡∏ï‡πâ‡∏≠‡∏á‡∏ã‡πà‡∏≠‡∏°")).length;

    passCount.textContent = rows.length - fail;
    failCount.textContent = fail;
    totalCount.textContent = rows.length;

    updateStickyPositions();
}


/* Toggle */
function toggleDetails(i,cat){
    const row = document.getElementById(`details-${i}-${cat}`);
    const open = row.style.display==="table-row";
    row.style.display = open ? "none" : "table-row";

    if (!open && cat==="img"){
        const data = GLOBAL_ROWS[i];
        const box = document.getElementById(`img-box-${i}`);
        box.innerHTML = "";

        (data["‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å/‡∏†‡∏≤‡∏¢‡πÉ‡∏ô"] || "").split(",").forEach(url=>{
            url = url.trim();
            if (!url) return;

            let img = convertDriveURL(url);
            box.innerHTML += `<img src="${img}" class="thumb" onclick="showImage('${img}')">`;
        });
    }
}


/* ZIP Download */
async function downloadImages(i){
    const row = GLOBAL_ROWS[i];
    const zip = new JSZip();
    const folder = zip.folder(row["‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ"]);

    let urls = (row["‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å/‡∏†‡∏≤‡∏¢‡πÉ‡∏ô"] || "").split(",");
    let count = 1;

    for (let u of urls){
        u = u.trim();
        if (!u) continue;

        let img = convertDriveURL(u);
        let blob = await fetch(img).then(r=>r.blob());
        let ext = blob.type.includes("png") ? "png" : "jpg";

        folder.file(`image_${count}.${ext}`, blob);
        count++;
    }

    zip.generateAsync({type:"blob"}).then(b=>saveAs(b, `images_${row["‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ"]}.zip`));
}


/* Export PDF */
async function exportPDF(){
    const { jsPDF } = window.jspdf;
    let pdf = new jsPDF();

    for (let i=0;i<GLOBAL_ROWS.length;i++){
        let row = GLOBAL_ROWS[i];
        let y = 10;

        pdf.setFontSize(16);
        pdf.text(`‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${row["‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ"]}`,10,y); y+=10;

        pdf.setFontSize(12);
        pdf.text(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à: ${row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"]}`,10,y); y+=6;
        pdf.text(`‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå: ${row["‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå"]}`,10,y); y+=6;

        /* ‚≠ê ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÅ‡∏ö‡∏ö Dynamic */
        let colUser = findColumn(row, "‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏ñ");
        pdf.text(`‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à: ${row[colUser] || "-"}`,10,y); y+=10;

        pdf.text("‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:",10,y); y+=6;
        pdf.text(row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°"]||"-",15,y); y+=10;

        let urls = (row["‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å/‡∏†‡∏≤‡∏¢‡πÉ‡∏ô"] || "").split(",");

        for (let u of urls){
            u=u.trim();
            if (!u) continue;

            let img = convertDriveURL(u);

            let dataUrl = await fetch(img)
            .then(r=>r.blob())
            .then(b=>new Promise(res=>{
                let fr=new FileReader();
                fr.onload=()=>res(fr.result);
                fr.readAsDataURL(b);
            }));

            pdf.addImage(dataUrl,"JPEG",10,y,80,60);
            y+=65;

            if (y>260){ pdf.addPage(); y=10; }
        }

        if (i < GLOBAL_ROWS.length - 1) pdf.addPage();
    }

    pdf.save("inspection_report.pdf");
}
</script>

</body>
</html>
