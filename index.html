<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡∏Ñ‡∏•‡∏±‡∏á‡∏®‡∏≤‡∏•‡∏≤‡∏¢‡∏≤</title>

<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
body{
    font-family:"Prompt", sans-serif;
    background:#f4f7fb;
    margin:0;
}

/* ---------- Sticky Layout ---------- */
header{
    background:white;
    padding:20px 40px;
    display:flex;
    align-items:center;
    border-bottom:1px solid #ddd;
    position:sticky;
    top:0;
    z-index:3000;
}

.filter-box{
    background:white;
    padding:20px;
    display:flex;
    gap:15px;
    flex-wrap:wrap;
    position:sticky;
    top:var(--topFilter);
    z-index:2500;
    border-bottom:1px solid #ddd;
}

.summary-container{
    background:#f4f7fb;
    padding:20px;
    display:flex;
    gap:20px;
    position:sticky;
    top:var(--topSummary);
    z-index:2200;
}

thead th{
    position:sticky;
    top:var(--topTableHead);
    background:#1E3A8A;
    color:white;
    z-index:2000;
}

/* ---------- Table ---------- */
table{
    width:100%;
    border-collapse:collapse;
    background:white;
    margin-top:20px;
}
th,td{
    padding:10px;
    border-bottom:1px solid #eee;
    text-align:center;
}

/* ---------- Summary ---------- */
.summary-card{
    flex:1;
    padding:20px;
    border-radius:12px;
    font-size:20px;
    font-weight:bold;
    color:white;
    text-align:center;
}
.pass{ background:#10B981; }
.fail{ background:#EF4444; }
.total{ background:#475569; }

/* ---------- Controls ---------- */
select,input{
    padding:10px 14px;
    border:1px solid #bbb;
    border-radius:8px;
    font-size:16px;
}
button{
    padding:10px 18px;
    border:none;
    color:white;
    border-radius:8px;
    cursor:pointer;
}
.load-btn{ background:#2563EB; }
.view-btn{ background:#1E40AF; }
.export-btn{ background:#047857; }

.details-row{ background:#eef3ff; }
.details-box{ padding:15px 30px; text-align:left; }

.thumb{
    width:120px;
    border-radius:8px;
    cursor:pointer;
}

.toggle-btn{
    cursor:pointer;
    color:#1E40AF;
    font-weight:600;
}
.toggle-btn:hover{ text-decoration:underline; }

.zip-btn{
    background:#7C3AED;
    padding:8px 14px;
    border-radius:6px;
}

/* ---------- Lightbox ---------- */
#lightbox{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.85);
    justify-content:center;
    align-items:center;
    z-index:9999;
}
#lightbox img{
    max-width:90%;
    max-height:90%;
    border-radius:12px;
}
</style>
</head>

<body>

<header>
    <img src="logo.png" style="height:60px; margin-right:15px;">
    <h1>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡∏Ñ‡∏•‡∏±‡∏á‡∏®‡∏≤‡∏•‡∏≤‡∏¢‡∏≤</h1>
</header>

<div class="filter-box">
    <select id="carType">
        <option value="car">üöó ‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå</option>
        <option value="motor">üèçÔ∏è ‡∏£‡∏ñ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå</option>
    </select>

    <select id="yearSelect"></select>

    <select id="monthSelect">
        <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
        <script>
            for(let m=1;m<=12;m++){
                document.write(`<option value="${m}">${m}</option>`);
            }
        </script>
    </select>

    <input id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‚Ä¶">

    <button class="load-btn" onclick="loadData()">‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    <button class="view-btn" onclick="loadData(true)">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    <button class="export-btn" onclick="exportPDF()">üìÑ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PDF</button>
</div>

<div class="summary-container">
    <div class="summary-card pass">‡∏ú‡πà‡∏≤‡∏ô: <span id="passCount">0</span></div>
    <div class="summary-card fail">‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô: <span id="failCount">0</span></div>
    <div class="summary-card total">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <span id="totalCount">0</span></div>
</div>

<div style="padding:20px;">
<table>
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
</table>
</div>

<!-- Lightbox -->
<div id="lightbox" onclick="this.style.display='none'">
    <img id="lightboxImg">
</div>

<script>
/* ---------- Sticky Positions ---------- */
function updateStickyPositions(){
    const h1 = document.querySelector("header").offsetHeight;
    const h2 = document.querySelector(".filter-box").offsetHeight;
    const h3 = document.querySelector(".summary-container").offsetHeight;

    document.documentElement.style.setProperty("--topFilter", h1+"px");
    document.documentElement.style.setProperty("--topSummary", (h1+h2)+"px");
    document.documentElement.style.setProperty("--topTableHead", (h1+h2+h3)+"px");
}
window.addEventListener("load", updateStickyPositions);
window.addEventListener("resize", updateStickyPositions);

/* ---------- Google Sheet ---------- */
const SHEETS = {
    car: "17RaQXYiBqKRuThFsIe78NQsZQAp3zgSLrq-JgFXDXpE",
    motor:"1fpLMthzvhCRKenfnsQfpomEJLxgAOYZuYvrBCGzzseI"
};
const TABS = { car:"car", motor:"motor" };

/* ---------- Helpers ---------- */
function findColumn(row, keyword){
    return Object.keys(row).find(k => k.trim().includes(keyword));
}

/* ‚≠ê Google Drive Direct Image */
function convertDriveURL(url){
    if(!url) return "";
    const match = url.match(/[-\w]{25,}/);
    if(!match) return "";
    return `https://drive.google.com/uc?export=view&id=${match[0]}`;
}

function showImage(url){
    lightboxImg.src = url;
    lightbox.style.display = "flex";
}

/* ---------- Year Select ---------- */
let yearNow = new Date().getFullYear();
for(let y=yearNow;y>=yearNow-5;y--){
    yearSelect.innerHTML += `<option>${y}</option>`;
}

let GLOBAL_ROWS = [];

/* ---------- Load Data ---------- */
function loadData(showAll=false){
    let type = carType.value;
    fetch(`https://opensheet.elk.sh/${SHEETS[type]}/${TABS[type]}`)
    .then(r=>r.json())
    .then(d=>{
        GLOBAL_ROWS = d;
        renderTable(showAll);
    });
}

/* ---------- Render Table ---------- */
function renderTable(showAll){
    let year = yearSelect.value;
    let month = monthSelect.value;
    let search = searchInput.value.trim();

    let rows = GLOBAL_ROWS.filter(r=>{
        if(!r["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"]) return false;
        let d = new Date(r["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"]);
        if(!showAll && year && d.getFullYear()!=year) return false;
        if(!showAll && month && d.getMonth()+1!=month) return false;
        if(search && !JSON.stringify(r).includes(search)) return false;
        return true;
    });

    tableHead.innerHTML = `
        <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à</th>
            <th>‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå</th>
            <th>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</th>
            <th>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏ñ</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            <th>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
        </tr>
    `;

    let html="";
    rows.forEach((row,i)=>{
        let colUser = findColumn(row,"‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏ñ");
        html+=`
        <tr>
            <td>${row["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à"]||""}</td>
            <td>${row["‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå"]||""}</td>
            <td>${row["‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ"]||""}</td>
            <td>${row[colUser]||"-"}</td>
            <td>${row["‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°"]||""}</td>
            <td class="toggle-btn" onclick="toggleImg(${i})">‚ñ∂ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</td>
        </tr>
        <tr id="img-${i}" class="details-row" style="display:none">
            <td colspan="6">
                <div class="details-box" id="img-box-${i}"></div>
            </td>
        </tr>`;
    });

    tableBody.innerHTML = html;

    totalCount.textContent = rows.length;
    passCount.textContent = rows.length;
    failCount.textContent = 0;

    updateStickyPositions();
}

function toggleImg(i){
    const row = document.getElementById(`img-${i}`);
    row.style.display = row.style.display==="table-row"?"none":"table-row";
    const box = document.getElementById(`img-box-${i}`);
    if(box.innerHTML) return;

    (GLOBAL_ROWS[i]["‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å/‡∏†‡∏≤‡∏¢‡πÉ‡∏ô"]||"")
    .split(",")
    .forEach(u=>{
        let img = convertDriveURL(u.trim());
        if(img){
            box.innerHTML+=`<img src="${img}" class="thumb" onclick="showImage('${img}')">`;
        }
    });
}

/* ---------- PDF ---------- */
async function exportPDF(){
    const { jsPDF } = window.jspdf;
    let pdf = new jsPDF();

    for(let i=0;i<GLOBAL_ROWS.length;i++){
        let r = GLOBAL_ROWS[i];
        pdf.text(`‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô: ${r["‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ"]}`,10,10);
        let urls=(r["‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å/‡∏†‡∏≤‡∏¢‡πÉ‡∏ô"]||"").split(",");

        let y=20;
        for(let u of urls){
            let img=convertDriveURL(u.trim());
            if(!img) continue;
            let data=await fetch(img).then(r=>r.blob()).then(b=>new Promise(res=>{
                let fr=new FileReader();
                fr.onload=()=>res(fr.result);
                fr.readAsDataURL(b);
            }));
            pdf.addImage(data,"JPEG",10,y,80,60);
            y+=65;
            if(y>260){ pdf.addPage(); y=10; }
        }
        if(i<GLOBAL_ROWS.length-1) pdf.addPage();
    }
    pdf.save("inspection_report.pdf");
}
</script>

</body>
</html>

